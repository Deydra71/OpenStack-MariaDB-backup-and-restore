---
- name: Delete OpenStack resources
  hosts: controller
  gather_facts: no
  tasks:
    - name: Delete keypair
      openstack.cloud.keypair:
        cloud: openstack-1-2-1
        name: cirros_keypair
        state: absent

    - name: Remove security group rules
      openstack.cloud.security_group_rule:
        cloud: openstack-1-2-1
        security_group: test_security_group
        protocol: "{{ item.protocol }}"
        direction: "{{ item.direction }}"
        port_range_min: "{{ item.port_range_min }}"
        port_range_max: "{{ item.port_range_max }}"
        state: absent
      loop:
        - { protocol: 'icmp', direction: 'ingress', port_range_min: -1, port_range_max: -1 }
        - { protocol: 'tcp', direction: 'ingress', port_range_min: 22, port_range_max: 22 }

    - name: Delete security group
      openstack.cloud.security_group:
        cloud: openstack-1-2-1
        name: test_security_group
        state: absent

    - name: Remove router interfaces
      openstack.cloud.router:
        cloud: openstack-1-2-1
        name: "{{ item.router.name }}"
        interfaces:
          - net: "net_{{ item.router.name.split('_')[1] }}"
            subnet: "subnet_net_{{ item.router.name.split('_')[1] }}"
            state: absent
      loop:
        - { router: "{{ routers_result.results[0].router }}" }
        - { router: "{{ routers_result.results[1].router }}" }

    - name: Delete routers
      openstack.cloud.router:
        cloud: openstack-1-2-1
        name: "{{ item }}"
        state: absent
      loop:
        - "router_project1"
        - "router_project2"

    - name: Delete subnets
      openstack.cloud.subnet:
        cloud: openstack-1-2-1
        name: "subnet_{{ item.network['name'] }}"
        network_name: "{{ item.network['name'] }}"
        state: absent
      loop:
        - { network: "{{ networks_result.results[0]['network'] }}" }
        - { network: "{{ networks_result.results[1]['network'] }}" }

    - name: Delete networks
      openstack.cloud.network:
        cloud: openstack-1-2-1
        name: "net_{{ item }}"
        state: absent
      loop:
        - "project1"
        - "project2"

    - name: Delete minimal flavor
      openstack.cloud.compute_flavor:
        cloud: openstack-1-2-1
        name: minimal_flavor
        state: absent

    - name: Delete users
      openstack.cloud.identity_user:
        cloud: openstack-1-2-1
        name: "{{ item }}"
        state: absent
      loop:
        - "user1"
        - "user2"

    - name: Delete projects
      openstack.cloud.project:
        cloud: openstack-1-2-1
        name: "{{ item }}"
        state: absent
      loop:
        - "project1"
        - "project2"
