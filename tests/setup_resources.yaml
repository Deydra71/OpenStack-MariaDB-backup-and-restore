---
- name: Set up OpenStack resources
  hosts: controller
  gather_facts: no
  tasks:
    - name: Create projects
      openstack.cloud.project:
        cloud: openstack-1-2-1
        endpoint_type: admin
        state: present
        name: "{{ item }}"
        enabled: True
      loop:
        - project1
        - project2

    - name: Create users
      openstack.cloud.identity_user:
        cloud: openstack-1-2-1
        name: "{{ item }}"
        password: "{{ item }}_password"
      loop:
        - user1
        - user2

    - name: Set up user access rights
      openstack.cloud.role_assignment:
        cloud: openstack-1-2-1
        role: "_member_"
        user: "{{ item.user }}"
        project: "{{ item.project }}"
      loop:
        - { user: 'user1', project: 'project1' }
        - { user: 'user2', project: 'project2' }

    - name: Create networks
      openstack.cloud.network:
        cloud: openstack-1-2-1
        name: "net_{{ item }}"
      register: networks_result
      loop:
        - project1
        - project2

    - name: Create subnets
      openstack.cloud.subnet:
        cloud: openstack-1-2-1
        name: "subnet_{{ item.network.name }}"
        network_name: "{{ item.network.name }}"
        cidr: "{{ item.cidr }}"
      loop:
        - { network: "{{ networks_result.resources[0] }}", cidr: '192.168.1.0/24' }
        - { network: "{{ networks_result.resources[1] }}", cidr: '192.168.2.0/24' }

    - name: Create routers
      openstack.cloud.router:
        cloud: openstack-1-2-1
        name: "router_{{ item }}"
      register: routers_result
      loop:
        - project1
        - project2

    - name: Attach routers to subnets
      openstack.cloud.router_interface:
        cloud: openstack-1-2-1
        router: "{{ item.router.name }}"
        subnet: "subnet_{{ item.router.name }}"
      loop:
        - { router: "{{ routers_result.resources[0] }}" }
        - { router: "{{ routers_result.resources[1] }}" }

    - name: Create security group
      openstack.cloud.security_group:
        cloud: openstack-1-2-1
        name: default_security_group
        description: Default security group

    - name: Add rules to security group
      openstack.cloud.security_group_rule:
        cloud: openstack-1-2-1
        security_group: default_security_group
        protocol: "{{ item.protocol }}"
        direction: "{{ item.direction }}"
        port_range_min: "{{ item.port_range_min }}"
        port_range_max: "{{ item.port_range_max }}"
      loop:
        - { protocol: 'icmp', direction: 'ingress', port_range_min: -1, port_range_max: -1 }
        - { protocol: 'tcp', direction: 'ingress', port_range_min: 22, port_range_max: 22 }

    - name: Create keypair
      openstack.cloud.keypair:
        cloud: openstack-1-2-1
        name: my_keypair

    - name: Create instances with basic cirros image
      openstack.cloud.server:
        cloud: openstack-1-2-1
        name: "instance"